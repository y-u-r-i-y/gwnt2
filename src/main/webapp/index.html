<!DOCTYPE html>
<html>
<head>
    <meta charset=UTF-8>
    <title>Gwnt duel</title>
    <script>
    </script>
    <style>
        div {
            outline: 1px solid grey;
            height: 100px;
        }
        #container {
            display: table;
            width: 100%;
            min-width: 800px;
        }

        #left, #middle, #right {
            display: table-cell;
        }
        #left {
            width: 300px;
        }
        #right {
            width: 250px;
            position: relative;
            height: 100%;
        }
        .row {
            margin: 2px 5px 2px 20px;
            position: relative;
        }
        .row-score-yours {
            margin: 0 auto;
            position: absolute;
            left: -42px;
            top: 12px;
            background-image: url('resources/row-score-bgnd-2.jpg');
            background-size: 100%;
            width: 50px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bolder;
        }
        .row-score-his {
            margin: 0 auto;
            position: absolute;
            left: -42px;
            top: 12px;
            background-image: url('resources/row-score-bgnd-2-enemy.jpg');
            background-size: 100%;
            width: 50px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bolder;
        }

        .row-horn {
            width: 100px;
            height: 100%;
            float: left;
            text-align: center;
            background-image: url("resources/horn-bkgrnd.jpg");
            background-size: 100%;
            outline: 0;
            transition: outline .5s linear;
            /*box-shadow: inset 2px -2px 5px 8px rgba(240,188,56,1);*/
        }
        .yours {}
        .divider {
            height: 20px;
            width: 800px;
            background-image: url("resources/divider-bgnd.jpg");
            background-size: 100%;
            justify-content: center;
        }
        .card {
            width: 55px;
            height: 85px;
            display: inline-block;
            padding: 5px;
            border-radius: 3px;
            text-align: left;
            position: relative;
            top: 2px;
            background-image: url("resources/gwent-card1.jpg");
            background-size: 120%;
            /*box-shadow: inset 0 0 0 1px rgba(255,255,255,0.5), 0 3px 6px -3px rgba(0,0,0,0.25);*/
            transition: outline .4s linear, opacity 1.5s linear;
            outline: 0px solid gold;
        }
        .card:hover {
            top: -5px;
            /*outline: 3px solid gold;*/
        }
        .center-div {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }

        #description-section {
            width: 200px;
            height: 375px;
        }

        #big-card {
            width: 200px;
            height: 375px;
            top: 300px;
            right: 25px;
            background-size: 100%;
            border-radius: 10px;
        }

        #weather-target {
            width: 250px;
            height: 135px;
            background-image: url("resources/weather-bgnd.jpg");
            background-size: 100%;
            margin: 5px;
            text-align: center;
            padding-top: 15px;
            }
        #weather-target > div {
            margin: 3px;
        }
        .played-row {
            text-align:center;
        }
        .modal {
            position: absolute;
            width: 100%;
            height: 100px;
            background-color: black;
            opacity: 0;
            color: white;
            z-index: 100;
            transition: opacity 0.5s linear;
        }
        .hidden {
            opacity: 0;
        }
        .visible {
            opacity: 1;
        }
        .hero {
            outline: 3px solid orangered;
        }
        .highlighted {
            outline: 3px solid gold;
        }

    </style>
    <script type="application/javascript">
        window.onload = function() {
            document.body.onselectstart = function() { return false; };
            document.body.onmousedown = function() { return false; };
            addCardsFaces();
        };
        document.onmouseover = function(event) {
            if (isPlayingHorn) {
                return; // leave selected horn card face
            }
            var element = event.target;
            // set description
            if (element.hasAttribute("description")) {
                document.getElementById("description-text").innerText = element.getAttribute("description");
            } else {
                document.getElementById("description-text").innerText = "";
            }
            // set card image
            // http://stackoverflow.com/questions/14013131/javascript-get-background-image-url-of-div
            if (element.classList.contains("card")) {
                var card = element;
                var style = card.currentStyle || window.getComputedStyle(card, false),
                        bg_image_url = style.backgroundImage.replace(/url\((['"])?(.*?)\1\)/gi, '$2').split(',')[0];
                var urlString = 'url(' + bg_image_url + ')';
                document.getElementById('big-card').style.backgroundImage =  urlString;
            } else {
                document.getElementById('big-card').style.backgroundImage =  "";
            }
        };

        function toArray(nodeList) {
            for (var a = [], l = nodeList.length; l--; a[l] = nodeList[l]);
            return a;
        }

        var isPlayingHorn = false; // TODO: make scoped
        var hornCard; // TODO: make scoped

        function toggleHighlightHornTargets () {
            // https://developer.mozilla.org/ru/docs/Web/API/NodeList
            var targets = document.getElementsByClassName('row-horn yours');
            toArray(targets).forEach(
                    function(hornTarget) {
                        hornTarget.classList.toggle('highlighted');
                    }
            );

        }
        function prepareToPlayHorn (card) {
            toggleHighlightHornTargets();
            isPlayingHorn = true;
            hornCard = card;
        }
        function cancelPlayingHorn () {
            if (isPlayingHorn) {
                toggleHighlightHornTargets();
                isPlayingHorn = false;
            }
        }
        function playHorn(hornLocation) {
            if (isPlayingHorn) {
                playCardSmoothly(hornCard, hornLocation);
                toggleHighlightHornTargets();
                isPlayingHorn = false;
            }
        }

        var time = 0;
        function singleClickOnCard (card) {
            // http://stackoverflow.com/questions/5497073/how-to-differentiate-single-click-event-and-double-click-event
            // https://gist.github.com/karbassi/639453
            // http://stackoverflow.com/questions/10211145/getting-current-date-and-time-in-javascript

            // !!!!!!! http://stackoverflow.com/questions/2024198/how-many-seconds-between-two-dates

            // card.classList.toggle('highlighted');

            var currentTime = new Date();
            console.log(((currentTime - time) / 1000));
            if (((currentTime - time) / 1000)  > .5) {
                console.log(" single clicked, delta: " + (currentTime - time) / 1000);
            } else {
                console.log("double clicked. ignored.")
            }
            time = currentTime;
        }
        function isSingleClick() {
            var currentTime = new Date();
            var delta = currentTime - time;
            console.log(((delta) / 1000));
            if ((delta / 1000)  > .5) {
                console.log(" single clicked, delta: " + delta / 1000);
                time = currentTime;
                return true;
            } else {
                console.log("double clicked. ignored.");
                time = currentTime;
                return false;
            }


        }
        function clickOnCard(card) {
            if (isPlayingHorn) {
                cancelPlayingHorn();
            }
            var type = card.getAttribute("type");
            var field;
            switch (type) {
                case "CLOSE":
                    field = document.getElementById("close-combat-row");
                    break;
                case "RANGED":
                    field = document.getElementById("ranged-combat-row");
                    break;
                case "SIEGE":
                    field = document.getElementById("siege-combat-row");
                    break;
                case "HORN":
                    prepareToPlayHorn(card);
                    return;
                case "WEATHER":
                    if (card.getAttribute('face') == "clear") {
                        discardCardSmoothly(card);
                        clearWeatherEffects();
                        return;
                    }
                    field = document.getElementById("weather-target");
                    break;
                case "LEADER":
                    break;
            }

            if (typeof field !== 'undefined') {
                playCardSmoothly(card, field);
            }
        }
        function clearWeatherEffects() {
            var weather = document.getElementById("weather-target");
            var currentWeatherEffects = weather.children;
            /* flushElement(weather); */

            toArray(currentWeatherEffects).forEach(
                function(card) { discardCardSmoothly(card); });
            clearDescription();
        }
        function discardCardSmoothly(card) {
            card.classList.toggle('hidden');
            setTimeout(function(){
                card.parentNode.removeChild(card);
            }, 400);
        }
        function playCardSmoothly(card, field) {
            card.classList.toggle('hidden');
            setTimeout(
                    function() {
                        field.appendChild(card);
                        setTimeout(
                                function() {
                                    card.classList.toggle('hidden');
                                    if (card.hasAttribute('hero')) {
                                        setTimeout(
                                                function() {
                                                    card.classList.toggle('hero');
                                                }, 1000);
                                    }
                                }, 200);
                    }, 400);
        }
        function showHide(doBetweenTransitions) {
            var play_back = ! document.getElementById('modal').classList.contains('visible');
            document.getElementById('modal').classList.toggle('visible');
            if (play_back) {
                setTimeout(
                    function() {
                        if (typeof doBetweenTransitions === 'function') {
                            /*doBetweenTransitions();*/
                        }
                        showHide();
                    }, 1000);
            }
        }
        function flushElement(e) {
            alert("not implemented");
        }
        function clearDescription() {
            var bc = document.getElementById('big-card');
            bc.style.backgroundImage = '';
            var d = document.getElementById('description-text');
            d.value = '';

        }
        function addCardsFaces() {
            var cards = document.querySelectorAll('.card');
            console.log(cards);
            toArray(cards).forEach(function(card){
                if (card.hasAttribute('deck')) {
                    addFace(card);
                }
            });
        }
        function addFace(card) {
            var urlStr = 'url("' + 'resources/' +
                    getDeckPartOfFaceUrl(card) + getCardPartOfFaceUrl(card)+ '")';
            card.style.backgroundImage = urlStr;
        }
        function getDeckPartOfFaceUrl(card) {
            switch (card.getAttribute('deck')) {
                case 'NEUTRAL':
                    return 'neutral-deck/';
                case 'NORTHERN':
                    return 'northern-deck/';
                default : return '';
            }
        }
        function getCardPartOfFaceUrl(card) {
            return card.getAttribute('face') + '.png';
        }

    </script>
</head>
<body style="margin: 2px;background-color: #101557;">

<div id="container">

    <!--animate visibility: http://www.greywyvern.com/?post=337 -->
    <!-- it hides one of the horn locations-->
    <!--<div id="modal" class="modal center-div"> modal text </div>-->

    <div id="left" style="position: relative;" >
        <div style="width:200px;height: 350px; position: absolute; top: 25px;left: 25px;"></div>
        <div id = "weather-target" class="center-div">
             <div id="card21" class="card" description="weather" type="WEATHER" deck="NEUTRAL" face="fog">R</div>
        </div>
        <div style="width:200px;height: 350px; position: absolute; bottom: 25px; left: 25px;"></div>
    </div>

    <div id="middle">
<!--
        <div class="row" id="his-hand" style="margin-bottom: 10px;">
            <div style="width: 100px; height: 100%; float: left;"></div>
            <div></div>
        </div>-->

        <div class="row" id="row1">
            <div class="row-score-his">123</div>
            <div class="row-horn"></div>
            <div></div>
        </div>
        <div class="row" id="row2">
            <div class="row-score-his">123</div>
            <div class="row-horn"></div>
            <div></div>
        </div>
        <div class="row" id="row3">
            <div class="row-score-his">123</div>
            <div class="row-horn"></div>
            <div></div>
        </div>



        <div id="field-border" class="divider">
        </div>



        <div id="close-combat" class="row" >
            <div class="row-horn yours" onclick="playHorn(this)"></div>
            <div class="row-score-yours">123</div>

            <div id="close-combat-row" class="played-row" ></div>
        </div>

        <div id="ranged-combat" class="row" >
            <div class="row-horn yours" onclick="playHorn(this)"></div>
            <div class="row-score-yours">123</div>
            <div id="ranged-combat-row" class="played-row" ></div>
        </div>

        <div id="siege-combat" class="row" >
            <div class="row-horn yours" onclick="playHorn(this)"></div>
            <div class="row-score-yours">123</div>
            <div id="siege-combat-row" class="played-row" ></div>
        </div>


        <div class="row" id="your-hand" style="margin-top: 10px;text-align: center;">
            <div style="width: 100px; height: 100%; float: left;"></div>
            <div>
                <div description="close"     type="CLOSE" hero="true"   class="card" deck="NORTHERN" face="roche"
                     ondblclick="clickOnCard(this)">C</div>
                <div description="ranged"    type="RANGED"   class="card" deck="NORTHERN" face="keira"
                     ondblclick="clickOnCard(this)">R</div>
                <div description="siege"     type="SIEGE"    class="card" deck="NORTHERN" face="catapult"
                     ondblclick="clickOnCard(this)">S</div>
                <div description="horn"      type="HORN"     class="card" deck="NEUTRAL"  face="horn"
                     ondblclick="clickOnCard(this)">H</div>
                <div description="weather"   type="WEATHER"  class="card" deck="NEUTRAL"  face="frost"
                     ondblclick="clickOnCard(this)">W</div>
                <div description="weather"   type="WEATHER"  class="card" deck="NEUTRAL"  face="rain"
                     ondblclick="clickOnCard(this)">W</div>
                <div description="weather"   type="WEATHER"  class="card" deck="NEUTRAL"  face="clear"
                     ondblclick="clickOnCard(this)">W</div>
                <div description="decoy"   type="DECOY"  class="card" deck="NEUTRAL"  face="decoy"
                     ondblclick="clickOnCard(this)">W</div>
            </div>
        </div>


    </div>
    <div id="right">
        <div style="width: 200px; height: 100px; position: absolute; top: 25px; right: 25px;"></div>

        <div id="description-section" class="center-div">
            <div id="big-card" ></div>
            <div id="description-text" style="height: 40px;color: white;"></div>
        </div>

        <div id="button" style="width: 200px; height: 100px; position: absolute; bottom: 25px; right: 25px;">
            <button onclick="showHide(function(){alert('!');})">show modal</button>
        </div>

    </div>
</div>

</body>
</html>
