<!DOCTYPE html>
<html>
<head>
    <meta charset=UTF-8>
    <title>Gwnt duel</title>

    <link rel="stylesheet" type="text/css" href="resources/css/styles.css"/>

    <script type="application/javascript">
        window.onload = function() {
            document.body.onselectstart = function() { return false; };
            document.body.onmousedown = function() { return false; };
            if (window.addEventListener) {
                window.addEventListener("resize", onresize);
            }
            addCardsFaces();

            // click handler for horn targets
            var targets = document.querySelectorAll('.your .row-horn');
            toArray(targets).forEach(
                    function(hornTarget) {
                        hornTarget.addEventListener("dblclick", clickOnHornTarget);
                    }
            );

            connect();
        };
        document.onmouseover = function(event) {
            if (isPlayingHorn) {
                return; // leave selected horn card face
            }
            var element = event.target;
            // set description
            if (element.hasAttribute("description")) {
                document.getElementById("description-text").innerText = element.getAttribute("description");
            } else {
                document.getElementById("description-text").innerText = "";
            }
            // set card image
            // http://stackoverflow.com/questions/14013131/javascript-get-background-image-url-of-div
            if (element.classList.contains("card")) {
                var card = element;
                var style = card.currentStyle || window.getComputedStyle(card, false),
                        bg_image_url = style.backgroundImage.replace(/url\((['"])?(.*?)\1\)/gi, '$2').split(',')[0];
                var urlString = 'url(' + bg_image_url + ')';
                document.getElementById('big-card').style.backgroundImage =  urlString;
                highlightRow(card.getAttribute('row'));
            } else {
                document.getElementById('big-card').style.backgroundImage =  "";
                highlightRow(false);
            }
        };
        var highlightedRow;
        function highlightRow(row) {
/*
            if (row) {
                var rowId;
                switch (row) {
                    case 'CLOSE': rowId = '#close-combat';
                        break;
                    case 'RANGED': rowId = '#ranged-combat';
                        break;
                    case 'SIEGE': rowId = '#siege-combat';
                        break;
                }
                highlightedRow = document.querySelector(rowId);
                if (highlightedRow)
                    highlightedRow.classList.toggle('highlighted-target');
            }
*/
        }

        function toArray(nodeList) {
            for (var a = [], l = nodeList.length; l--; a[l] = nodeList[l]);
            return a;
        }

        var isPlayingHorn = false; // TODO: make scoped
        var hornCard; // TODO: make scoped

        var isPlayingDecoy = false; // TODO: make scoped
        var decoyCard; // TODO: make scoped

        function toggleHighlightHornTargets () {
            // https://developer.mozilla.org/ru/docs/Web/API/NodeList
            var targets = document.querySelectorAll('.your .row-horn');
            toArray(targets).forEach(
                    function(hornTarget) {
                        hornTarget.classList.toggle('highlighted-target');
                    }
            );

        }
        function prepareToPlayHorn (card) {
            toggleHighlightHornTargets();
            isPlayingHorn = true;
            hornCard = card;
        }
        function cancelPlayingHorn () {
            if (isPlayingHorn) {
                toggleHighlightHornTargets();
                isPlayingHorn = false;
            }
        }
        function clickOnHornTarget(hornLocation) {
            debugger;
            // ws.send(JSON.stringify({ command: "PLAY_HORN", target: card.id }));
            // playCardSmoothly(hornCard, hornLocation);
            // toggleHighlightHornTargets();
        }

        function toggleHighlightDecoyTargets () {
            // https://developer.mozilla.org/ru/docs/Web/API/NodeList
            var targets = document.querySelectorAll('.your .card:not([hero])');
            toArray(targets).forEach(
                    function(hornTarget) {
                        hornTarget.classList.toggle('highlighted-target');
                    }
            );

        }
        function prepareToPlayDecoy (card) {
            toggleHighlightDecoyTargets();
            isPlayingDecoy = true;
            decoyCard = card;
        }
        function cancelPlayingDecoy () {
            if (isPlayingDecoy) {
                toggleHighlightHornTargets();
                isPlayingDecoy = false;
            }
        }
        function playDecoy(target) {
            if (isPlayingDecoy) {

                switchCards(decoyCard, target);
                //playCardSmoothly(decoyCard, target);
                toggleHighlightDecoyTargets();
                isPlayingDecoy = false;
            }
        }
        function switchCards(obj1, obj2) {
            obj1.classList.toggle('hidden');
            obj2.classList.toggle('hidden');

            setTimeout(
                    function() {
                        var temp = document.createElement("div");
                        obj1.parentNode.insertBefore(temp, obj1);

                        // move obj1 to right before obj2
                        obj2.parentNode.insertBefore(obj1, obj2);

                        // move obj2 to right before where obj1 used to be
                        temp.parentNode.insertBefore(obj2, temp);

                        // remove temporary marker node
                        temp.parentNode.removeChild(temp);

                        setTimeout(
                                function() {
                                    obj1.classList.toggle('hidden');
                                    obj2.classList.toggle('hidden');
                                }, 200);
                    }, 400);
        }



        var time = 0;
        function singleClickOnCard (card) {
            // http://stackoverflow.com/questions/5497073/how-to-differentiate-single-click-event-and-double-click-event
            // https://gist.github.com/karbassi/639453
            // http://stackoverflow.com/questions/10211145/getting-current-date-and-time-in-javascript

            // !!!!!!! http://stackoverflow.com/questions/2024198/how-many-seconds-between-two-dates

            // card.classList.toggle('highlighted');

            var currentTime = new Date();
            console.log(((currentTime - time) / 1000));
            if (((currentTime - time) / 1000)  > .5) {
                console.log(" single clicked, delta: " + (currentTime - time) / 1000);
            } else {
                console.log("double clicked. ignored.")
            }
            time = currentTime;
        }
        function isSingleClick() {
            var currentTime = new Date();
            var delta = currentTime - time;
            console.log(((delta) / 1000));
            if ((delta / 1000)  > .5) {
                console.log(" single clicked, delta: " + delta / 1000);
                time = currentTime;
                return true;
            } else {
                console.log("double clicked. ignored.");
                time = currentTime;
                return false;
            }
        }

        function clickOnCard(event) {
            var card = event.currentTarget;
            lastClickedCard = card;
            ws.send(JSON.stringify({ command: "CARD_CLICKED", target: card.id }));
        }

        function clickOnCard_OLD(event) {
            var card = event.currentTarget;
            // TODO: remove after useful code is reused
            // what to highlight or where to play
            // in the manner of 'highlight: id1, id2, id3'

            // https://css-tricks.com/almanac/selectors/a/attribute/

            if (isPlayingHorn) {
                cancelPlayingHorn(); // because a new horn card may be clicked
            }
            if (isPlayingDecoy && goodDecoyTarget(card)) {
                playDecoy(card);
                return;
            }

            ws.send(JSON.stringify({command: "PLAY_CARD", target: card.id}));


            return;//////////////////////////////////////////////////////////////////////////////

            if (isPlayingHorn) {
                cancelPlayingHorn(); // because a new horn card may be clicked
            }
            if (isPlayingDecoy && goodDecoyTarget(card)) {
                playDecoy(card);
                return;
            }
            var row = card.getAttribute("row");
            var field;
            switch (row) {
                case "CLOSE":
                    field = document.getElementById("close-combat-row");
                    break;
                case "RANGED":
                    field = document.getElementById("ranged-combat-row");
                    break;
                case "SIEGE":
                    field = document.getElementById("siege-combat-row");
                    break;
                case "HORN":
                    prepareToPlayHorn(card);
                    return;
                case "DECOY":
                    prepareToPlayDecoy(card);
                    return;
                case "WEATHER":
                    if (card.getAttribute('face') == "clear") {
                        discardCardSmoothly(card);
                        clearWeatherEffects();
                        return;
                    }
                    field = document.getElementById("weather-target");
                    break;
                case "LEADER":
                    break;
            }

            if (typeof field !== 'undefined') {
                playCardSmoothly(card, field);
            }
        }
        function clearWeatherEffects() {
            var weather = document.getElementById("weather-target");
            var currentWeatherEffects = weather.children;
            /* flushElement(weather); */

            toArray(currentWeatherEffects).forEach(
                function(card) { discardCardSmoothly(card, 1000); });
            clearDescription();
        }
        function discardCardSmoothly(card, timeout) {
            timeout = timeout || 400;
            card.classList.toggle('hidden');
            setTimeout(function(){
                card.parentNode.removeChild(card);
            }, timeout);
        }
        function playCardSmoothly(card, field) {
            card.style.marginLeft = "0px";
            card.classList.toggle('hidden');
            setTimeout(
                    function() {
                        field.appendChild(card);
                        setTimeout(
                                function() {
                                    card.classList.toggle('hidden');
                                    if (card.hasAttribute('hero')) {
                                        setTimeout(
                                                function() {
                                                    card.classList.toggle('hero');
                                                }, 1000);
                                    }
                                }, 200);
                    }, 400);
        }
        function showHide(doBetweenTransitions) {
            var play_back = ! document.getElementById('modal').classList.contains('visible');
            document.getElementById('modal').classList.toggle('visible');
            if (play_back) {
                setTimeout(
                    function() {
                        if (typeof doBetweenTransitions === 'function') {
                            /*doBetweenTransitions();*/
                        }
                        showHide();
                    }, 1000);
            }
        }
        function goodDecoyTarget(card) {
            // TODO: should be decided on the server side
            return card != decoyCard && !card.hasAttribute('hero')
                    && card.getAttribute('row') != 'HORN'
                    && card.parentNode.id != 'cards-to-play';
        }
        function flushElement(e) {
            alert("not implemented");
        }
        function clearDescription() {
            var bc = document.getElementById('big-card');
            bc.style.backgroundImage = '';
            var d = document.getElementById('description-text');
            d.value = '';

        }
        function addCardsFaces() {
            var cards = document.querySelectorAll('.card');
            console.log(cards);
            toArray(cards).forEach(function(card){
                if (card.hasAttribute('deck')) {
                    addFace(card);
                }
            });
        }
        function addFace(card) {
            var urlStr = 'url("' + 'resources/' +
                    getDeckPartOfFaceUrl(card) + getCardPartOfFaceUrl(card)+ '")';
            card.style.backgroundImage = urlStr;
        }
        function getDeckPartOfFaceUrl(card) {
            switch (card.getAttribute('deck')) {
                case 'NEUTRAL':
                    return 'neutral-deck/';
                case 'NORTHERN':
                    return 'northern-deck/';
                default : return '';
            }
        }
        function getCardPartOfFaceUrl(card) {
            return card.getAttribute('face') + '.png';
        }
        function askForCards() {
            ws.send(JSON.stringify({command: "DEAL_CARDS"}));
        }
        function connect() {
            ws = new WebSocket("ws://localhost:8080/json");
            ws.onmessage = onMessage;
        }
        var lastClickedCard;
        function onMessage(msg) {
            var response = JSON.parse(msg.data);
            switch (response.command) {
                case "DEAL_CARDS":
                    if (Array.isArray(response.target)) {
                        response.target.forEach(function(card) { processDealtCard(card); });
                    }
                    compactCards(document.getElementById('cards-to-play'));
                    break;
                case "HIGHLIGHT_ROW":
                    console.log(response);
                    break;
                case "TOGGLE_HIGHLIGHT_CARDS":
                    console.log(response);
                    response.target.forEach(function(id){
                        document.getElementById(id).classList.toggle('highlighted-target');
                    });
                    break;
                case "HIGHLIGHT_HORN_TARGETS":
                    console.log(response);
                    toggleHighlightHornTargets();
                    break;
                case "PLAY_HORN":
                    console.log(response);
                    //playCardSmoothly(hornCard, response.target);
                    toggleHighlightHornTargets();
                    break;
                case "PLAY_WEATHER":
                    console.log(response);
                    var weatherTarget = document.getElementById("weather-target");
                    playCardSmoothly(lastClickedCard, weatherTarget);
                    break;
                case "SWITCH_CARDS":
                    console.log(response);
                    var fromCard = document.getElementById(response.target.from);
                    var toCard = document.getElementById(response.target.to);
                    switchCards(fromCard, toCard);
                    break;
                case "UPDATE_ROW_SCORE":
                    console.log(response);
                    // TODO: implement var row = document.getElementById(response.target);
                    break;
                case "PLAY_CARD":
                    console.log(response);
                    var where = document.querySelector("#" + response.target + ">.played-row");
                    if (where && lastClickedCard) {
                        playCardSmoothly(lastClickedCard, where);
                    }
                    break;
                case "EVENT_IGNORED":
                    console.log(response);
                    break;
            }
        }
        function processDealtCard(card) {
            var div = document.createElement("div");
            div.setAttribute("id", card.id);
            div.setAttribute("row", card.type);
            div.setAttribute("description", card.description);
            div.setAttribute("deck", card.deckType);
            div.setAttribute("face", card.face);

            if (card.hero) {
                div.setAttribute("hero", "true");
            }
            if (card.healer) {
                div.setAttribute("healer", "true");
            }
            div.classList.add("card");
            div.addEventListener("dblclick", clickOnCard);
            addFace(div);
            var cardContainer = document.getElementById("cards-to-play");
            cardContainer.appendChild(div);

        }
        function compactCards(container) {
            var cards = container.children;
            var count = cards.length;
            if (count < 3) {
                return;
            }
            var cardWidth = cards[0].offsetWidth;
            var containerWidth = container.clientWidth;
            if (cardWidth * count <= containerWidth) {
                return;
            }
            var marginDelta = (containerWidth - cardWidth * count) / (count - 2);
            console.log(marginDelta);
            for (var i = 1; i < cards.length; i++) {
                cards[i].style.marginLeft = marginDelta + "px";
            }
        }
        function onresize() {
             compactCards(document.getElementById('cards-to-play'));
        }

            var ws;
    </script>
</head>
<body style="margin: 2px;background-color: #101557;">

<div id="container">

    <!--animate visibility: http://www.greywyvern.com/?post=337 -->
    <!-- it hides one of the horn locations-->
    <!--<div id="modal" class="modal center-div"> modal text </div>-->

    <div id="left" style="position: relative;" >
        <div style="width:200px;height: 350px; position: absolute; top: 25px;left: 25px;"></div>
        <div id = "weather-target" class="center-div">
             <div id="card21" class="card" description="weather" row="WEATHER" deck="NEUTRAL" face="fog"></div>
        </div>
        <div id="player-info" style="width:200px;height: 350px; position: absolute; bottom: 25px; left: 25px;">
            <div id="leader-container" style="width: 100px; height: 100%; float: left;">
                <div description="foltest" row="LEADER" class="card" deck="NORTHERN" face="foltest_king"
                     ondblclick="clickOnCard(event)"></div>
            </div>

        </div>
    </div>

    <div id="middle">

        <div id="HIS_CLOSE_COMBAT_ROW" class="row" id="row1">
            <div class="row-score-his">123</div>
            <div class="row-horn"></div>
            <div></div>
        </div>
        <div id="HIS_RANGED_COMBAT_ROW" class="row" id="row2">
            <div class="row-score-his">123</div>
            <div class="row-horn"></div>
            <div></div>
        </div>
        <div id="HIS_SIEGE_COMBAT_ROW" class="row" id="row3">
            <div class="row-score-his">123</div>
            <div class="row-horn"></div>
            <div></div>
        </div>



        <div id="field-border" class="divider">
        </div>


        <span class="your">
        <div id="YOUR_CLOSE_COMBAT_ROW" class="row" >
            <div class="row-horn" ></div>
            <div class="row-score-yours">123</div>

            <div class="played-row" ></div>
        </div>

        <div id="YOUR_RANGED_COMBAT_ROW" class="row" >
            <div class="row-horn" ></div>
            <div class="row-score-yours">123</div>
            <div class="played-row" ></div>
        </div>

        <div id="YOUR_SIEGE_COMBAT_ROW" class="row" >
            <div class="row-horn" ></div>
            <div class="row-score-yours">123</div>
            <div class="played-row" ></div>
        </div>
        </span>

        <div class="row" id="your-hand" style="margin-top: 10px;text-align: center;">
            <div id="cards-to-play">

            </div>
        </div>


    </div>
    <div id="right">
        <div style="width: 200px; height: 100px; position: absolute; top: 25px; right: 25px;"></div>

        <div id="description-section" class="center-div">
            <div id="big-card" ></div>
            <div id="description-text" style="height: 40px;color: white;"></div>
        </div>

        <div id="buttons" style="width: 200px; height: 100px; position: absolute; bottom: 25px; right: 25px;">
            <button onclick="askForCards();">deal cards</button>
        </div>

    </div>
</div>

</body>
</html>
