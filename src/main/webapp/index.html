<!DOCTYPE html>
<html>
<head>
    <meta charset=UTF-8>
    <title>Gwnt duel</title>
    <script>
    </script>
    <style>
        div {
            outline: 1px solid grey;
            height: 100px;
        }
        #container {
            display: table;
            width: 100%;
            min-width: 1360px;
        }

        #left, #middle, #right {
            display: table-cell;
        }
        #left {
            width: 320px;
        }
        #right {
            width: 250px;
            position: relative;
            height: 100%;
        }
        .row {
            margin: 2px 5px 2px 20px;
            position: relative;
        }
        .row-score-yours {
            margin: 0 auto;
            position: absolute;
            left: -42px;
            top: 12px;
            background-image: url('resources/row-score-bgnd-2.jpg');
            background-size: 100%;
            width: 50px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bolder;
        }
        .row-score-his {
            margin: 0 auto;
            position: absolute;
            left: -42px;
            top: 12px;
            background-image: url('resources/row-score-bgnd-2-enemy.jpg');
            background-size: 100%;
            width: 50px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bolder;
        }

        .row-horn {
            width: 100px;
            height: 100%;
            float: left;
            text-align: center;
            background-image: url("resources/horn-bkgrnd.jpg");
            background-size: 100%;
            outline: 0;
            transition: outline .5s linear;
            /*box-shadow: inset 2px -2px 5px 8px rgba(240,188,56,1);*/
        }
        .your {}
        .divider {
            height: 20px;
            width: 800px;
            background-image: url("resources/divider-bgnd.jpg");
            background-size: 100%;
            justify-content: center;
        }
        .card {
            width: 55px;
            height: 85px;
            display: inline-block;
            padding: 4px;
            border-radius: 3px;
            text-align: left;
            position: relative;
            top: 2px;
            background-image: url("resources/gwent-card1.jpg");
            background-size: 120%;
            /*box-shadow: inset 0 0 0 1px rgba(255,255,255,0.5), 0 3px 6px -3px rgba(0,0,0,0.25);*/
            transition: outline .4s linear, opacity 1.5s linear;
            outline: 0px solid gold;
        }
        .card:hover {
            top: -5px;
            /*outline: 3px solid gold;*/
        }
        .center-div {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }

        #description-section {
            width: 200px;
            height: 375px;
        }

        #big-card {
            width: 200px;
            height: 375px;
            top: 300px;
            right: 25px;
            background-size: 100%;
            border-radius: 10px;
        }

        #weather-target {
            width: 250px;
            height: 135px;
            background-image: url("resources/weather-bgnd.jpg");
            background-size: 100%;
            margin: 5px;
            text-align: center;
            padding-top: 15px;
            }
        #weather-target > div {
            margin: 3px;
        }
        .played-row {
            text-align:center;
        }
        .modal {
            position: absolute;
            width: 100%;
            height: 100px;
            background-color: black;
            opacity: 0;
            color: white;
            z-index: 100;
            transition: opacity 0.5s linear;
        }
        .hidden {
            opacity: 0;
        }
        .visible {
            opacity: 1;
        }
        .hero {
            outline: 2px solid orangered;
        }
        .highlighted-target {
            outline: 3px solid gold;
        }
        .highlighted-target:hover {
            border: 1px solid transparent;
        }

    </style>
    <script row="application/javascript">
        window.onload = function() {
            document.body.onselectstart = function() { return false; };
            document.body.onmousedown = function() { return false; };
            addCardsFaces();
            connect();
        };
        document.onmouseover = function(event) {
            if (isPlayingHorn) {
                return; // leave selected horn card face
            }
            var element = event.target;
            // set description
            if (element.hasAttribute("description")) {
                document.getElementById("description-text").innerText = element.getAttribute("description");
            } else {
                document.getElementById("description-text").innerText = "";
            }
            // set card image
            // http://stackoverflow.com/questions/14013131/javascript-get-background-image-url-of-div
            if (element.classList.contains("card")) {
                var card = element;
                var style = card.currentStyle || window.getComputedStyle(card, false),
                        bg_image_url = style.backgroundImage.replace(/url\((['"])?(.*?)\1\)/gi, '$2').split(',')[0];
                var urlString = 'url(' + bg_image_url + ')';
                document.getElementById('big-card').style.backgroundImage =  urlString;
                highlightRow(card.getAttribute('row'));
            } else {
                document.getElementById('big-card').style.backgroundImage =  "";
                highlightRow(false);
            }
        };
        var highlightedRow;
        function highlightRow(row) {
/*
            if (row) {
                var rowId;
                switch (row) {
                    case 'CLOSE': rowId = '#close-combat';
                        break;
                    case 'RANGED': rowId = '#ranged-combat';
                        break;
                    case 'SIEGE': rowId = '#siege-combat';
                        break;
                }
                highlightedRow = document.querySelector(rowId);
                if (highlightedRow)
                    highlightedRow.classList.toggle('highlighted-target');
            }
*/
        }

        function toArray(nodeList) {
            for (var a = [], l = nodeList.length; l--; a[l] = nodeList[l]);
            return a;
        }

        var isPlayingHorn = false; // TODO: make scoped
        var hornCard; // TODO: make scoped

        var isPlayingDecoy = false; // TODO: make scoped
        var decoyCard; // TODO: make scoped

        function toggleHighlightHornTargets () {
            // https://developer.mozilla.org/ru/docs/Web/API/NodeList
            var targets = document.querySelectorAll('.your .row-horn');
            toArray(targets).forEach(
                    function(hornTarget) {
                        hornTarget.classList.toggle('highlighted-target');
                    }
            );

        }
        function prepareToPlayHorn (card) {
            toggleHighlightHornTargets();
            isPlayingHorn = true;
            hornCard = card;
        }
        function cancelPlayingHorn () {
            if (isPlayingHorn) {
                toggleHighlightHornTargets();
                isPlayingHorn = false;
            }
        }
        function playHorn(hornLocation) {
            if (isPlayingHorn) {
                playCardSmoothly(hornCard, hornLocation);
                toggleHighlightHornTargets();
                isPlayingHorn = false;
            }
        }

        function toggleHighlightDecoyTargets () {
            // https://developer.mozilla.org/ru/docs/Web/API/NodeList
            var targets = document.querySelectorAll('.your .card:not([hero])');
            toArray(targets).forEach(
                    function(hornTarget) {
                        hornTarget.classList.toggle('highlighted-target');
                    }
            );

        }
        function prepareToPlayDecoy (card) {
            toggleHighlightDecoyTargets();
            isPlayingDecoy = true;
            decoyCard = card;
        }
        function cancelPlayingDecoy () {
            if (isPlayingDecoy) {
                toggleHighlightHornTargets();
                isPlayingDecoy = false;
            }
        }
        function playDecoy(target) {
            if (isPlayingDecoy) {

                switchCards(decoyCard, target);
                //playCardSmoothly(decoyCard, target);
                toggleHighlightDecoyTargets();
                isPlayingDecoy = false;
            }
        }
        function switchCards(obj1, obj2) {
            obj1.classList.toggle('hidden');
            obj2.classList.toggle('hidden');

            setTimeout(
                    function() {
                        var temp = document.createElement("div");
                        obj1.parentNode.insertBefore(temp, obj1);

                        // move obj1 to right before obj2
                        obj2.parentNode.insertBefore(obj1, obj2);

                        // move obj2 to right before where obj1 used to be
                        temp.parentNode.insertBefore(obj2, temp);

                        // remove temporary marker node
                        temp.parentNode.removeChild(temp);

                        setTimeout(
                                function() {
                                    obj1.classList.toggle('hidden');
                                    obj2.classList.toggle('hidden');
                                }, 200);
                    }, 400);
        }



        var time = 0;
        function singleClickOnCard (card) {
            // http://stackoverflow.com/questions/5497073/how-to-differentiate-single-click-event-and-double-click-event
            // https://gist.github.com/karbassi/639453
            // http://stackoverflow.com/questions/10211145/getting-current-date-and-time-in-javascript

            // !!!!!!! http://stackoverflow.com/questions/2024198/how-many-seconds-between-two-dates

            // card.classList.toggle('highlighted');

            var currentTime = new Date();
            console.log(((currentTime - time) / 1000));
            if (((currentTime - time) / 1000)  > .5) {
                console.log(" single clicked, delta: " + (currentTime - time) / 1000);
            } else {
                console.log("double clicked. ignored.")
            }
            time = currentTime;
        }
        function isSingleClick() {
            var currentTime = new Date();
            var delta = currentTime - time;
            console.log(((delta) / 1000));
            if ((delta / 1000)  > .5) {
                console.log(" single clicked, delta: " + delta / 1000);
                time = currentTime;
                return true;
            } else {
                console.log("double clicked. ignored.");
                time = currentTime;
                return false;
            }
            debugger;
        }



        function clickOnCard(event) {
            var card = event.currentTarget;
            // TODO: should be decided on the server side:
            // what to highlight or where to play
            // in the manner of 'highlight: id1, id2, id3'

            // https://css-tricks.com/almanac/selectors/a/attribute/



            if (isPlayingHorn) {
                cancelPlayingHorn(); // because a new horn card may be clicked
            }
            if (isPlayingDecoy && goodDecoyTarget(card)) {
                playDecoy(card);
                return;
            }
            var row = card.getAttribute("row");
            var field;
            switch (row) {
                case "CLOSE":
                    field = document.getElementById("close-combat-row");
                    break;
                case "RANGED":
                    field = document.getElementById("ranged-combat-row");
                    break;
                case "SIEGE":
                    field = document.getElementById("siege-combat-row");
                    break;
                case "HORN":
                    prepareToPlayHorn(card);
                    return;
                case "DECOY":
                    prepareToPlayDecoy(card);
                    return;
                case "WEATHER":
                    if (card.getAttribute('face') == "clear") {
                        discardCardSmoothly(card);
                        clearWeatherEffects();
                        return;
                    }
                    field = document.getElementById("weather-target");
                    break;
                case "LEADER":
                    break;
            }

            if (typeof field !== 'undefined') {
                playCardSmoothly(card, field);
            }
        }
        function clearWeatherEffects() {
            var weather = document.getElementById("weather-target");
            var currentWeatherEffects = weather.children;
            /* flushElement(weather); */

            toArray(currentWeatherEffects).forEach(
                function(card) { discardCardSmoothly(card, 1000); });
            clearDescription();
        }
        function discardCardSmoothly(card, timeout) {
            timeout = timeout || 400;
            card.classList.toggle('hidden');
            setTimeout(function(){
                card.parentNode.removeChild(card);
            }, timeout);
        }
        function playCardSmoothly(card, field) {
            card.classList.toggle('hidden');
            setTimeout(
                    function() {
                        field.appendChild(card);
                        setTimeout(
                                function() {
                                    card.classList.toggle('hidden');
                                    if (card.hasAttribute('hero')) {
                                        setTimeout(
                                                function() {
                                                    card.classList.toggle('hero');
                                                }, 1000);
                                    }
                                }, 200);
                    }, 400);
        }
        function showHide(doBetweenTransitions) {
            var play_back = ! document.getElementById('modal').classList.contains('visible');
            document.getElementById('modal').classList.toggle('visible');
            if (play_back) {
                setTimeout(
                    function() {
                        if (typeof doBetweenTransitions === 'function') {
                            /*doBetweenTransitions();*/
                        }
                        showHide();
                    }, 1000);
            }
        }
        function goodDecoyTarget(card) {
            // TODO: should be decided on the server side
            return card != decoyCard && !card.hasAttribute('hero')
                    && card.getAttribute('row') != 'HORN'
                    && card.parentNode.id != 'cards-to-play';
        }
        function flushElement(e) {
            alert("not implemented");
        }
        function clearDescription() {
            var bc = document.getElementById('big-card');
            bc.style.backgroundImage = '';
            var d = document.getElementById('description-text');
            d.value = '';

        }
        function addCardsFaces() {
            var cards = document.querySelectorAll('.card');
            console.log(cards);
            toArray(cards).forEach(function(card){
                if (card.hasAttribute('deck')) {
                    addFace(card);
                }
            });
        }
        function addFace(card) {
            var urlStr = 'url("' + 'resources/' +
                    getDeckPartOfFaceUrl(card) + getCardPartOfFaceUrl(card)+ '")';
            card.style.backgroundImage = urlStr;
        }
        function getDeckPartOfFaceUrl(card) {
            switch (card.getAttribute('deck')) {
                case 'NEUTRAL':
                    return 'neutral-deck/';
                case 'NORTHERN':
                    return 'northern-deck/';
                default : return '';
            }
        }
        function getCardPartOfFaceUrl(card) {
            return card.getAttribute('face') + '.png';
        }
        function askForCards() {
            ws.send("DEAL_CARDS");
        }
        function connect() {
            ws = new WebSocket("ws://localhost:8080/json");
            ws.onmessage = onMessage;
        }
        function onMessage(msg) {
            console.log(msg.data);
            var response = JSON.parse(msg.data);
            if(response.command === "DEAL_CARDS") {
                if (Array.isArray(response.target)) {
                    response.target.forEach(function(card) { processDealtCard(card); });
                }
            }
        }
        function processDealtCard(card) {
            var div = document.createElement("div");
            div.setAttribute("row", card.type);
            div.setAttribute("description", card.description);
            div.setAttribute("deck", card.deckType);
            div.setAttribute("face", card.face);

            if (card.hero) {
                div.setAttribute("hero", "true");
            }
            if (card.healer) {
                div.setAttribute("healer", "true");
            }
            div.classList.add("card");
            div.addEventListener("dblclick", clickOnCard);
            addFace(div);
            document.getElementById("cards-to-play").appendChild(div);
        }
        var ws;
    </script>
</head>
<body style="margin: 2px;background-color: #101557;">

<div id="container">

    <!--animate visibility: http://www.greywyvern.com/?post=337 -->
    <!-- it hides one of the horn locations-->
    <!--<div id="modal" class="modal center-div"> modal text </div>-->

    <div id="left" style="position: relative;" >
        <div style="width:200px;height: 350px; position: absolute; top: 25px;left: 25px;"></div>
        <div id = "weather-target" class="center-div">
             <div id="card21" class="card" description="weather" row="WEATHER" deck="NEUTRAL" face="fog"></div>
        </div>
        <div style="width:200px;height: 350px; position: absolute; bottom: 25px; left: 25px;"></div>
    </div>

    <div id="middle">

        <div class="row" id="row1">
            <div class="row-score-his">123</div>
            <div class="row-horn"></div>
            <div></div>
        </div>
        <div class="row" id="row2">
            <div class="row-score-his">123</div>
            <div class="row-horn"></div>
            <div></div>
        </div>
        <div class="row" id="row3">
            <div class="row-score-his">123</div>
            <div class="row-horn"></div>
            <div></div>
        </div>



        <div id="field-border" class="divider">
        </div>


        <span class="your">
        <div id="close-combat" class="row" >
            <div class="row-horn" onclick="playHorn(this)"></div>
            <div class="row-score-yours">123</div>

            <div id="close-combat-row" class="played-row" ></div>
        </div>

        <div id="ranged-combat" class="row" >
            <div class="row-horn" onclick="playHorn(this)"></div>
            <div class="row-score-yours">123</div>
            <div id="ranged-combat-row" class="played-row" ></div>
        </div>

        <div id="siege-combat" class="row" >
            <div class="row-horn" onclick="playHorn(this)"></div>
            <div class="row-score-yours">123</div>
            <div id="siege-combat-row" class="played-row" ></div>
        </div>
        </span>

        <div class="row" id="your-hand" style="margin-top: 10px;text-align: center;">
            <div id="leader-container" style="width: 100px; height: 100%; float: left;">
                <div description="foltest" row="LEADER" class="card" deck="NORTHERN" face="foltest_king"
                     ondblclick="clickOnCard()"></div>
            </div>
            <div id="cards-to-play">

            </div>
        </div>


    </div>
    <div id="right">
        <div style="width: 200px; height: 100px; position: absolute; top: 25px; right: 25px;"></div>

        <div id="description-section" class="center-div">
            <div id="big-card" ></div>
            <div id="description-text" style="height: 40px;color: white;"></div>
        </div>

        <div id="button" style="width: 200px; height: 100px; position: absolute; bottom: 25px; right: 25px;">
            <button onclick="askForCards();">ask for cards</button>
        </div>

    </div>
</div>

</body>
</html>
